<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-scheme="indigo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosdns 仪表盘 - 终极移动重构版 v10.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 优化版UI的CSS (v10.0) --- */
        :root { 
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            --font-family-mono: "SF Mono", "Fira Code", "Consolas", monospace; 
            --border-radius-lg: 16px; 
            --border-radius-md: 12px; 
            --border-radius-sm: 8px; 
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04); 
            --shadow-md: 0 4px 10px rgba(0,0,0,0.08); 
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1); 
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            --transition-med: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* 主题色系统 */
        [data-color-scheme="indigo"] { --color-accent-primary: #4f46e5; --color-accent-primary-hover: #4338ca; --glow-color: rgba(79, 70, 229, 0.2); }
        [data-color-scheme="pink"] { --color-accent-primary: #ec4899; --color-accent-primary-hover: #db2777; --glow-color: rgba(236, 72, 153, 0.2); }
        [data-color-scheme="teal"] { --color-accent-primary: #14b8a6; --color-accent-primary-hover: #0d9488; --glow-color: rgba(20, 184, 166, 0.15); }
        [data-color-scheme="orange"] { --color-accent-primary: #f97316; --color-accent-primary-hover: #ea580c; --glow-color: rgba(249, 115, 22, 0.2); }
        [data-theme="dark"][data-color-scheme="indigo"] { --color-accent-primary: #58a6ff; --color-accent-primary-hover: #80b6f8; --glow-color: rgba(88, 166, 255, 0.15); }
        [data-theme="dark"][data-color-scheme="pink"] { --color-accent-primary: #f778ba; --color-accent-primary-hover: #f599ce; --glow-color: rgba(247, 120, 186, 0.15); }
        [data-theme="dark"][data-color-scheme="teal"] { --color-accent-primary: #2dd4bf; --color-accent-primary-hover: #5eead4; --glow-color: rgba(45, 212, 191, 0.15); }
        [data-theme="dark"][data-color-scheme="orange"] { --color-accent-primary: #fb923c; --color-accent-primary-hover: #fdba74; --glow-color: rgba(251, 146, 60, 0.15); }

        /* 基础明暗主题变量 */
        [data-theme="light"] { --color-bg: #f5f8ff; --color-bg-card: #ffffff; --color-bg-alt: #f0f3f8; --color-text-primary: #0f172a; --color-text-secondary: #64748b; --color-border: #e2e8f0; --color-accent-secondary: #ec4899; --color-accent-text: #ffffff; --color-danger: #ef4444; --color-danger-hover: #dc2626; --color-success: #22c55e; }
        [data-theme="dark"] { --color-bg: #0d1117; --color-bg-card: #161b22; --color-bg-alt: #21262d; --color-text-primary: #c9d1d9; --color-text-secondary: #8b949e; --color-border: #30363d; --color-accent-secondary: #f778ba; --color-accent-text: #ffffff; --color-danger: #f87171; --color-danger-hover: #ff9191; --color-success: #56d364; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: color-mix(in srgb, var(--color-accent-primary) 40%, transparent); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--color-accent-primary) 60%, transparent); }

        *, *::before, *::after { box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text-primary); margin: 0; position: relative; overflow-x: hidden; transition: background-color var(--transition-slow), color var(--transition-slow); }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 400px; background: radial-gradient(ellipse at top, var(--glow-color), transparent 70%); z-index: 0; pointer-events: none; transition: var(--transition-slow); }
        .container { max-width: 1300px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1;}
        h1, h2, h3, p { margin: 0; }
        h1 { font-size: 2.25rem; font-weight: 800; }
        h2 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem; }
        h3 { font-size: 0.9rem; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px;}
        a { color: var(--color-accent-primary); text-decoration: none; font-weight: 600; transition: var(--transition-fast); }
        a:hover { color: var(--color-accent-primary-hover); }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1.5rem; }
        .header-main-actions { display: flex; align-items: center; gap: 0.75rem; margin-left: auto; }
        
        .main-nav { display: inline-flex; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.25rem; position: relative; }
        .main-nav-slider { position: absolute; top: 0.25rem; bottom: 0.25rem; border-radius: var(--border-radius-sm); background: var(--color-accent-primary); box-shadow: var(--shadow-md); transition: all var(--transition-med); z-index: 0; }
        .main-nav a { display: flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.6rem 1.1rem; color: var(--color-text-secondary); font-weight: 600; font-size: 0.95rem; position: relative; z-index: 1; transition: color var(--transition-med); white-space: nowrap; }
        .main-nav a.active { color: var(--color-accent-text) !important; }
        .main-nav a .status-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; opacity: 0.6; transition: all var(--transition-med); }
        .main-nav a.active .status-indicator { opacity: 1; }
        .main-nav a .status-indicator.running { background-color: var(--color-success); opacity: 1; animation: pulse-small 2s infinite; }
        .main-nav a .status-indicator.stopped { background-color: var(--color-danger); opacity: 1; }
        @keyframes pulse-small { 0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--color-success) 40%, transparent); } 70% { box-shadow: 0 0 0 5px transparent; } }
        
        .refresh-btn { display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: var(--border-radius-md); background-color: var(--color-bg-alt); color: var(--color-text-secondary); border: 1px solid var(--color-border); cursor: pointer; transition: all var(--transition-fast); }
        .refresh-btn svg { transition: transform var(--transition-med); }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) { color: var(--color-accent-primary); border-color: var(--color-accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) svg { transform: rotate(45deg); }
        .refresh-btn[aria-busy="true"] { cursor: wait; pointer-events: none; }
        .refresh-btn[aria-busy="true"] svg { animation: spin 1s linear infinite; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .stat-card { padding: 2rem; border-radius: var(--border-radius-lg); position: relative; overflow: hidden; color: var(--color-accent-text); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); transition: transform var(--transition-med), box-shadow var(--transition-med); }
        .stat-card.default-gradient-1 { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .stat-card.default-gradient-2 { background: linear-gradient(135deg, #ec4899, #f59e0b); }
        .stat-card.theme-gradient { background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); }
        .stat-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.2); }
        .stat-card h3 { color: var(--color-accent-text); opacity: 0.8; text-transform: none; font-size: 1.1rem; font-weight: 500; display: flex; align-items: center; gap: 0.75rem;}
        .stat-card .value { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-top: 1rem; }
        .stat-card .icon-bg { position: absolute; right: -20px; bottom: -20px; font-size: 120px; opacity: 0.1; transform: rotate(-15deg); transition: transform var(--transition-slow); }
        .stat-card:hover .icon-bg { transform: rotate(-10deg) scale(1.1); }
        .sparkline-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; opacity: 0.5; mask-image: linear-gradient(to top, rgba(0,0,0,1) 50%, transparent 100%); -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 50%, transparent 100%); }
        .sparkline-container svg { width: 100%; height: 100%; }
        .sparkline-path { stroke: var(--color-accent-text, #fff); stroke-width: 2.5; fill: url(#sparkline-gradient); fill-opacity: 0.2; stroke-linecap: round; stroke-linejoin: round; }
        
        .card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); transition: var(--transition-fast); position: relative; }
        .card::before { content: ""; position: absolute; top: var(--glow-y, 50%); left: var(--glow-x, 50%); transform: translate(-50%, -50%); width: 250px; height: 250px; background: radial-gradient(circle, var(--glow-color), transparent 70%); opacity: 0; transition: opacity 0.4s ease-out; pointer-events: none; z-index: 0; }
        .card:hover::before { opacity: 1; }
        .card > * { position: relative; z-index: 1; }
        .card-header { padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-body { padding: 1.75rem; }
        
        .card-header .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .control-item { display: flex; align-items: center; gap: 1rem; font-size: 1rem; flex-wrap: wrap; }
        .control-item strong { color: var(--color-text-primary); font-weight: 500; flex-shrink: 0;}
        .control-item > div, .control-item > form, .control-item > button { margin-left: auto; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem; }
        #capacity-form { display: grid; grid-template-columns: 1fr auto; gap: 1rem; }
        
        .auto-refresh-form { display: flex; align-items: center; gap: 1rem; }
        .auto-refresh-form input[type="number"] { width: 80px; text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: var(--transition-fast); border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-fast); border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-accent-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .color-palette { display: flex; gap: 0.5rem; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: var(--transition-fast); }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.active { border-color: var(--color-accent-primary); }

        .theme-switcher-container { background-color: var(--color-bg-alt); border-radius: 99px; padding: 4px; display: inline-flex; position: relative; border: 1px solid var(--color-border); }
        .theme-switcher-button { border: none; background: none; cursor: pointer; padding: 6px; border-radius: 50%; color: var(--color-text-secondary); display: flex; align-items: center; justify-content: center; z-index: 1; transition: color var(--transition-med); }
        .theme-switcher-button.active { color: var(--color-accent-primary); }
        .theme-switcher-button svg { width: 20px; height: 20px; }
        .theme-switcher-slider { position: absolute; top: 4px; width: 32px; height: 32px; background-color: var(--color-bg-card); border-radius: 50%; box-shadow: var(--shadow-sm); transition: transform var(--transition-med); z-index: 0; }
        [data-theme="dark"] .theme-switcher-slider { transform: translateX(36px); }

        .button { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; font-size: 0.95rem; font-weight: 600; border-radius: var(--border-radius-sm); border: 1px solid transparent; cursor: pointer; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.05); transition: all var(--transition-fast); }
        .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .button:active:not(:disabled) { transform: translateY(0); box-shadow: var(--shadow-sm); }
        .button.primary { background-color: var(--color-accent-primary); color: var(--color-accent-text); }
        .button.primary:hover:not(:disabled) { background-color: var(--color-accent-primary-hover); }
        .button.secondary { background-color: var(--color-bg-card); color: var(--color-text-primary); border-color: var(--color-border); }
        .button.secondary:hover:not(:disabled) { border-color: var(--color-accent-primary); color: var(--color-accent-primary); }
        .button.danger { background-color: var(--color-danger); color: #fff; }
        .button.danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .button svg { width: 1.2em; height: 1.2em; }
        
        input[type="search"], input[type="text"], input[type="number"] { width: 100%; padding: 0.8rem 1.2rem; font-size: 1rem; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); color: var(--color-text-primary); transition: var(--transition-fast); }
        input:focus { outline: none; border-color: var(--color-accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent-primary) 25%, transparent); }
        
        .rankings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; }
        .scrollable-table-container { max-height: 400px; overflow: auto; }
        #log-query-table-container { max-height: calc(100vh - 300px); min-height: 200px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; table-layout: auto; }
        th, td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--color-border); transition: background-color var(--transition-fast); }
        .col-time { white-space: nowrap; width: 1%; }
        .col-domain { max-width: 300px; word-break: break-all; }
        .truncate-text { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th.text-right, td.text-right { text-align: right; }
        th.text-left, td.text-left { text-align: left; }
        thead th { background-color: var(--color-bg-alt); position: sticky; top: 0; z-index: 2; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--color-text-secondary); }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-child(even) { background-color: var(--color-bg-alt); }
        tbody tr:hover { background-color: color-mix(in srgb, var(--color-accent-primary) 8%, transparent); }
        tbody td a.clickable-link { position: relative; text-decoration: none; }
        tbody td a.clickable-link::after { content: ''; position: absolute; width: 0; height: 1px; bottom: -3px; left: 50%; transform: translateX(-50%); background-color: var(--color-accent-primary); transition: width var(--transition-fast); }
        tbody td a.clickable-link:hover::after { width: 100%; }

        td.details-trigger { cursor: help; }
        td.details-trigger:hover .truncate-text { color: var(--color-accent-primary); }
        
        .empty-state-row td { text-align: center !important; padding: 3rem 1.5rem !important; white-space: normal !important; }
        .empty-state-content { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; color: var(--color-text-secondary); }
        .empty-state-content svg { width: 48px; height: 48px; opacity: 0.5; }
        .empty-state-content strong { color: var(--color-text-primary); font-size: 1.1rem; }

        .tab-content { display: none; margin-top: 2.5rem; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .client-alias { font-weight: 600; } 
        .client-ip-tag { font-size: 0.8em; color: var(--color-text-secondary); margin-left: 0.5em; background-color: color-mix(in srgb, var(--color-border) 50%, transparent); padding: 0.2rem 0.5rem; border-radius: var(--border-radius-sm); } 
        
        .answers-tooltip { visibility: hidden; opacity: 0; position: fixed; padding: 0.75rem 1rem; border-radius: var(--border-radius-md); background: var(--color-bg-alt); border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); width: max-content; max-width: 400px; z-index: 9999; transition: opacity 0.2s, visibility 0.2s, transform 0.2s; text-align: left; pointer-events: none; font-size: 0.9rem; transform: translateY(10px); } 
        .answers-tooltip.visible { visibility: visible; opacity: 1; transform: translateY(0); }
        .answers-tooltip h5 { margin: 0 0 0.75rem 0; font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; } 
        .answers-tooltip ul { margin: 0; padding: 0; list-style-type: none; display: flex; flex-direction: column; gap: 0.4rem; } 
        .answers-tooltip li { font-family: var(--font-family-mono); white-space: normal; word-break: break-all; } 
        .answers-tooltip small { font-size: 0.85em; opacity: 0.8; } 

        #toast { position: fixed; top: 20px; right: 20px; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: var(--border-radius-sm); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-20px) scale(0.95); box-shadow: var(--shadow-lg); color: var(--color-accent-text); font-weight: 500; } 
        #toast.show { opacity: 1; visibility: visible; transform: translateY(0) scale(1); } 
        #toast.success { background-color: var(--color-success); } 
        #toast.error { background-color: var(--color-danger); }
        #toast svg { width: 1.25em; height: 1.25em; }

        dialog { border: none; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); padding: 0; max-width: 600px; width: 90%; background-color: var(--color-bg-card); color: var(--color-text-primary); } 
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); } 
        .modal-header { padding: 1.25rem 1.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); } 
        .modal-body { padding: 1.75rem; max-height: 60vh; overflow-y: auto; } 
        .modal-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--color-border); display: flex; justify-content: flex-end; gap: 0.75rem; background-color: var(--color-bg-alt); } 
        .alias-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius-sm); } 
        .alias-item:nth-child(even) { background-color: var(--color-bg-alt); }
        
        #log-loader { text-align: center; padding: 2rem; display: none; }
        #log-loader .spinner { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid var(--color-border); border-top-color: var(--color-accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .control-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .control-module { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .control-module h3 { font-size: 1rem; font-weight: 600; color: var(--color-text-primary); text-transform: none; letter-spacing: 0; padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); margin-bottom: 0.25rem; }

        /* --- 全面优化的响应式布局 --- */
        @media (max-width: 992px) {
            .page-header { justify-content: center; }
            h1 { flex-basis: 100%; text-align: center; margin-bottom: 0.5rem; }
            .header-main-actions { order: 1; flex-grow: 1; justify-content: center; }
        }
        
        @media (max-width: 768px) {
            html { font-size: 15px; } 
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.8rem; }
            .card-header h2 { flex-grow: 1; }
            .rankings-grid { grid-template-columns: 1fr; gap: 2rem; }
            
            .hide-on-mobile { display: none !important; }
            
            td, th { white-space: normal; word-break: break-all; }

            .control-panel-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .control-item { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .control-item > div, .control-item > form, .control-item > button { margin-left: 0; width: 100%; }
            .button-group { grid-template-columns: 1fr; gap: 0.75rem; }
            #capacity-form { grid-template-columns: 1fr; gap: 0.75rem; }
            .auto-refresh-form { flex-direction: row; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
            .color-palette { justify-content: flex-start; }
        }
        @media (max-width: 480px) {
            .alias-item { grid-template-columns: 1fr; gap: 0.5rem; text-align: center; }
            .alias-item input { text-align: center; }
            .alias-item button { width: 100%; }
        }
    </style>
</head>
<body>
    <main class="container">
        <header class="page-header">
            <h1>Mosdns 仪表盘</h1>
            <div class="header-main-actions">
                <nav class="main-nav">
                    <div class="main-nav-slider"></div>
                    <a href="#overview" class="tab-link active" data-tab="overview" role="tab">概览</a>
                    <a href="#log-query" class="tab-link" data-tab="log-query" role="tab">查询日志</a>
                    <a href="#system-control" class="tab-link" data-tab="system-control" role="tab">
                        <span class="status-indicator"></span>
                        <span>系统</span>
                    </a>
                </nav>
                <button id="global-refresh-btn" class="refresh-btn" title="刷新数据" aria-label="刷新数据" aria-busy="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                </button>
            </div>
        </header>

        <div id="toast"></div>

        <dialog id="alias-modal">
            <header class="modal-header">
                <h2>管理客户端别名</h2>
                <button class="button secondary" id="close-alias-modal" aria-label="Close" style="min-width:auto; padding:0.3rem 0.5rem;">✕</button>
            </header>
            <div class="modal-body">
                <p>为客户端 IP 设置别名，方便在日志中快速识别。</p>
                <div id="alias-list-container"></div>
            </div>
            <footer class="modal-footer">
                <button id="import-aliases-btn" class="button secondary"><span>导入配置</span></button>
                <button id="export-aliases-btn" class="button secondary"><span>导出配置</span></button>
            </footer>
        </dialog>
        <input type="file" id="import-alias-file-input" accept=".json" style="display: none;">
        
        <section id="overview-tab" class="tab-content active" role="tabpanel">
            <div class="stats-grid">
                <div class="stat-card" id="stat-card-1">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11.25 4.53335C11.6642 4.44457 12.0858 4.44457 12.5 4.53335C17.1524 5.54133 21 9.80443 21 14.6465C21 19.9806 16.9706 22 12 22C7.02944 22 3 19.9806 3 14.6465C3 9.80443 6.84759 5.54133 11.25 4.53335ZM12 2C6.47715 2 2 7.02165 2 14.6465C2 21.4939 6.27609 24 12 24C17.7239 24 22 21.4939 22 14.6465C22 7.02165 17.5228 2 12 2Z"></path></svg><span>总查询数</span></h3>
                    <div id="total-queries" class="value">--</div>
                    <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V4C20 2.89543 19.1046 2 18 2ZM11 14H8V12H11V14ZM16 10H8V8H16V10Z"></path></svg></div>
                    <div class="sparkline-container" id="sparkline-total"></div>
                </div>
                <div class="stat-card" id="stat-card-2">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM11 6V11H16V13H11V18H9V11H4V9H9V6H11Z"></path></svg><span>平均处理时间 (ms)</span></h3>
                    <div id="avg-duration" class="value">--</div>
                    <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 11.0711L14.1213 13.1924L15.5355 11.7782L12.7071 9L12 9.70711V11.0711ZM13 13H11V17H13V13Z"></path></svg></div>
                    <div class="sparkline-container" id="sparkline-avg"></div>
                </div>
            </div>
            
            <div class="rankings-grid" style="margin-top: 2.5rem;">
                <div class="card" id="top-domains-card">
                    <header class="card-header"><h2>域名请求排行</h2></header>
                    <div class="card-body scrollable-table-container">
                        <table>
                            <thead><tr><th class="col-domain">域名</th><th class="text-right">请求数</th></tr></thead>
                            <tbody id="top-domains-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" id="top-clients-card">
                    <header class="card-header"><h2>客户端请求排行</h2></header>
                    <div class="card-body scrollable-table-container">
                        <table>
                            <thead><tr><th class="col-client">客户端</th><th class="text-right">请求数</th></tr></thead>
                            <tbody id="top-clients-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
                
            <div class="card" id="slowest-queries-card" style="margin-top: 2.5rem;">
                <header class="card-header"><h2>最慢查询</h2></header>
                <div class="card-body scrollable-table-container">
                    <table>
                        <thead><tr><th class="col-time hide-on-mobile">时间</th><th class="col-domain details-trigger">域名</th><th class="hide-on-mobile col-duration text-right">耗时 (ms)</th><th class="col-client hide-on-mobile">客户端</th><th class="col-response hide-on-mobile">响应</th></tr></thead>
                        <tbody id="slowest-queries-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="log-query-tab" class="tab-content">
            <div class="card">
                <header class="card-header">
                    <h2>查询与过滤日志</h2>
                    <div class="header-actions">
                        <button id="manage-aliases-btn" class="button secondary"><span>管理别名</span></button>
                    </div>
                </header>
                <div class="card-body">
                    <input type="search" id="log-search" placeholder="实时搜索域名、IP、别名、响应..." style="margin-bottom: 1rem;">
                    <div class="scrollable-table-container" id="log-query-table-container">
                        <table>
                            <thead><tr><th class="col-time">时间</th><th class="col-domain">域名</th><th class="col-type hide-on-mobile">类型</th><th class="col-duration text-right hide-on-mobile">耗时(ms)</th><th class="col-client hide-on-mobile">客户端</th><th class="col-response hide-on-mobile">响应</th></tr></thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                        <div id="log-loader"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="system-control-tab" class="tab-content">
             <div class="control-panel-grid">
                <div class="control-module">
                    <h3>审计状态</h3>
                    <div class="control-item">
                        <strong>运行状态:</strong> <span id="audit-status">查询中...</span>
                    </div>
                    <div class="button-group">
                        <button id="toggle-audit-btn" class="button primary" disabled data-default-text="请稍后"><span>请稍后</span></button>
                        <button id="clear-audit-btn" class="button danger" data-default-text="清空日志"><span>清空日志</span></button>
                    </div>
                </div>
                <div class="control-module">
                    <h3>日志容量</h3>
                    <div class="control-item">
                        <strong>当前容量:</strong> <span id="audit-capacity">查询中...</span>
                    </div>
                    <form id="capacity-form">
                        <input type="number" id="new-capacity" placeholder="新容量 (将清空日志)" required min="1" max="100000">
                        <button type="submit" class="button primary" data-default-text="设置"><span>设置</span></button>
                    </form>
                </div>
                <div class="control-module">
                    <h3>自动刷新</h3>
                     <form id="auto-refresh-form" class="auto-refresh-form">
                        <label class="switch" for="auto-refresh-toggle" style="display: contents; cursor: pointer;">
                            <strong>启用</strong>
                            <label class="switch">
                                <input type="checkbox" id="auto-refresh-toggle">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <div>
                            <input type="number" id="auto-refresh-interval" min="5">
                            <span>秒/次</span>
                        </div>
                    </form>
                </div>
                <div class="control-module">
                    <h3>主题与外观</h3>
                    <div class="control-item">
                        <strong>颜色方案</strong>
                        <div class="color-palette">
                            <button class="color-swatch" data-color="indigo" style="background-color: #4f46e5;" title="靛蓝" aria-label="靛蓝"></button>
                            <button class="color-swatch" data-color="pink" style="background-color: #ec4899;" title="粉色" aria-label="粉色"></button>
                            <button class="color-swatch" data-color="teal" style="background-color: #14b8a6;" title="青色" aria-label="青色"></button>
                            <button class="color-swatch" data-color="orange" style="background-color: #f97316;" title="橙色" aria-label="橙色"></button>
                        </div>
                    </div>
                    <div class="control-item">
                        <strong>明暗模式</strong>
                        <div class="theme-switcher-container">
                            <div class="theme-switcher-slider"></div>
                            <button id="light-theme-btn" class="theme-switcher-button" aria-label="切换到明亮模式">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                            </button>
                            <button id="dark-theme-btn" class="theme-switcher-button" aria-label="切换到黑暗模式">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CONSTANTS = {
            API_BASE_URL: `${window.location.protocol}//${window.location.hostname}:9099`,
            LOGS_PER_PAGE: 50,
            HISTORY_LENGTH: 30,
            DEFAULT_AUTO_REFRESH_INTERVAL: 15,
            ANIMATION_DURATION: 1000
        };

        let state = {
            isUpdating: false, isCapturing: false, allLogs: [], filteredLogs: [], currentPage: 0, isLoadingMore: false, clientAliases: {}, slowestQueries: [],
            autoRefresh: { enabled: true, intervalId: null, intervalSeconds: CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL },
            data: { totalQueries: { current: null, previous: 0 }, avgDuration: { current: null, previous: 0 } },
            history: { totalQueries: [], avgDuration: [] }
        };
        
        const elements = {
            html: document.documentElement,
            container: document.querySelector('.container'),
            lightThemeBtn: document.getElementById('light-theme-btn'),
            darkThemeBtn: document.getElementById('dark-theme-btn'),
            colorSwatches: document.querySelectorAll('.color-swatch'),
            navContainer: document.querySelector('.main-nav'),
            navSlider: document.querySelector('.main-nav-slider'),
            tabLinks: document.querySelectorAll('.tab-link'),
            tabContents: document.querySelectorAll('.tab-content'),
            globalRefreshBtn: document.getElementById('global-refresh-btn'),
            autoRefreshToggle: document.getElementById('auto-refresh-toggle'),
            autoRefreshIntervalInput: document.getElementById('auto-refresh-interval'),
            autoRefreshForm: document.getElementById('auto-refresh-form'),
            statCard1: document.getElementById('stat-card-1'),
            statCard2: document.getElementById('stat-card-2'),
            totalQueries: document.getElementById('total-queries'),
            avgDuration: document.getElementById('avg-duration'),
            sparklineTotal: document.getElementById('sparkline-total'),
            sparklineAvg: document.getElementById('sparkline-avg'),
            auditStatus: document.getElementById('audit-status'),
            toggleAuditBtn: document.getElementById('toggle-audit-btn'),
            clearAuditBtn: document.getElementById('clear-audit-btn'),
            auditCapacity: document.getElementById('audit-capacity'),
            capacityForm: document.getElementById('capacity-form'),
            newCapacityInput: document.getElementById('new-capacity'),
            topDomainsBody: document.getElementById('top-domains-body'),
            topClientsBody: document.getElementById('top-clients-body'),
            slowestQueriesBody: document.getElementById('slowest-queries-body'),
            logSearch: document.getElementById('log-search'),
            logTableBody: document.getElementById('log-table-body'),
            logQueryTableContainer: document.getElementById('log-query-table-container'),
            logLoader: document.getElementById('log-loader'),
            toast: document.getElementById('toast'),
            aliasModal: document.getElementById('alias-modal'),
            aliasListContainer: document.getElementById('alias-list-container'),
            importAliasInput: document.getElementById('import-alias-file-input'),
            systemControlTabIndicator: document.querySelector('a[data-tab="system-control"] .status-indicator')
        };
        
        const api = {
            fetch: async (url, options = {}) => { try { const response = await fetch(url, { ...options, signal: options.signal }); if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`); const contentType = response.headers.get('content-type'); if (contentType && contentType.includes('application/json')) return response.json(); return { success: true, message: await response.text() }; } catch (error) { if (error.name !== 'AbortError') { ui.showToast(`网络请求失败: ${error.message}`, 'error'); console.error(error); } throw error; } },
            getStatus: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/status`, { signal }),
            getLogs: async (signal) => { try { const logs = await api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/logs`, { signal }); return Array.isArray(logs) ? logs.sort((a, b) => new Date(b.query_time) - new Date(a.query_time)) : []; } catch { return []; } },
            getCapacity: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { signal }),
            start: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/start`, { method: 'POST' }),
            stop: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/stop`, { method: 'POST' }),
            clear: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/clear`, { method: 'POST' }),
            setCapacity: (capacity) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ capacity: parseInt(capacity, 10) }) }),
        };

        const ui = {
            showToast(message, type = 'success') {
                if (!elements.toast) return;
                const icon = type === 'success' 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>`;
                elements.toast.innerHTML = `${icon}<span>${message}</span>`;
                elements.toast.className = `show ${type}`; 
                setTimeout(() => { elements.toast.className = elements.toast.className.replace('show', ''); }, 3000);
            },
            setLoading(button, isLoading) { if (!button) return; button.disabled = isLoading; const textSpan = button.querySelector('span'); if (textSpan) { if (!button.dataset.defaultText) { button.dataset.defaultText = textSpan.textContent; } textSpan.textContent = isLoading ? '处理中...' : button.dataset.defaultText; } },
            updateStatus(isCapturing) {
                if (!elements.toggleAuditBtn || !elements.auditStatus) return;
                this.setLoading(elements.toggleAuditBtn, false);
                const statusIndicator = elements.systemControlTabIndicator;
                if(statusIndicator) statusIndicator.className = 'status-indicator';

                if (typeof isCapturing === 'boolean') {
                    state.isCapturing = isCapturing;
                    elements.auditStatus.textContent = isCapturing ? '运行中' : '已停止';
                    elements.auditStatus.style.color = isCapturing ? 'var(--color-success)' : 'var(--color-danger)';
                    const actionText = isCapturing ? '关闭审计' : '开启审计';
                    elements.toggleAuditBtn.querySelector('span').textContent = actionText;
                    elements.toggleAuditBtn.dataset.defaultText = actionText;
                    elements.toggleAuditBtn.className = `button ${isCapturing ? 'danger' : 'primary'}`;
                    if(statusIndicator) statusIndicator.classList.add(isCapturing ? 'running' : 'stopped');

                } else {
                    elements.auditStatus.textContent = '未知';
                    elements.auditStatus.style.color = 'var(--color-text-secondary)';
                    elements.toggleAuditBtn.querySelector('span').textContent = '刷新状态';
                    elements.toggleAuditBtn.dataset.defaultText = '刷新状态';
                }
            },
            updateCapacity(capacity) { if (elements.auditCapacity) elements.auditCapacity.textContent = capacity != null ? `${capacity.toLocaleString()} 条` : '查询失败'; },
            updateOverviewStats() {
                animateValue(elements.totalQueries, state.data.totalQueries.previous, state.data.totalQueries.current, CONSTANTS.ANIMATION_DURATION);
                animateValue(elements.avgDuration, state.data.avgDuration.previous, state.data.avgDuration.current, CONSTANTS.ANIMATION_DURATION);
                state.history.totalQueries.push(state.data.totalQueries.current ?? 0);
                state.history.avgDuration.push(state.data.avgDuration.current ?? 0);
                if (state.history.totalQueries.length > CONSTANTS.HISTORY_LENGTH) state.history.totalQueries.shift();
                if (state.history.avgDuration.length > CONSTANTS.HISTORY_LENGTH) state.history.avgDuration.shift();
                if (elements.sparklineTotal) elements.sparklineTotal.innerHTML = generateSparklineSVG(state.history.totalQueries, 300, 60);
                if (elements.sparklineAvg) elements.sparklineAvg.innerHTML = generateSparklineSVG(state.history.avgDuration, 300, 60);
            },
            renderLogTable(logs, append = false) { 
                if (!elements.logTableBody) return;
                if (!append) elements.logTableBody.innerHTML = ''; 
                if (logs.length === 0 && !append) { renderTable(elements.logTableBody, [], () => {}, 'log-query'); return; }
                
                const rows = logs.map(log => {
                    const tr = document.createElement('tr');
                    const globalIndex = state.filteredLogs.indexOf(log);
                    tr.innerHTML = `
                        <td class="col-time">${formatDate(log.query_time)}</td>
                        <td class="col-domain details-trigger" data-log-index="${globalIndex}">
                            <span class="truncate-text">${log.query_name}</span>
                        </td>
                        <td class="col-type hide-on-mobile">${log.query_type}</td>
                        <td class="col-duration text-right hide-on-mobile">${log.duration_ms.toFixed(2)}</td>
                        <td class="col-client hide-on-mobile">${aliasManager.getDisplayName(log.client_ip)}</td>
                        <td class="col-response hide-on-mobile">${getResponseSummary(log)}</td>
                    `;
                    return tr;
                });
                elements.logTableBody.append(...rows);
            }
        };
        
        const aliasManager = {
            load: () => { state.clientAliases = JSON.parse(localStorage.getItem('mosdnsClientAliases')) || {}; },
            save: () => { localStorage.setItem('mosdnsClientAliases', JSON.stringify(state.clientAliases)); },
            getDisplayName: (ip) => state.clientAliases[ip] ? `<span class="client-alias">${state.clientAliases[ip]}</span><span class="client-ip-tag">${ip}</span>` : ip,
            set(ip, name) { if (name) state.clientAliases[ip] = name; else delete state.clientAliases[ip]; this.save(); rerenderAllViews(); },
            renderEditableList() { if (!elements.aliasListContainer) return; elements.aliasListContainer.innerHTML = ''; const uniqueIps = [...new Set(state.allLogs.map(log => log.client_ip))].sort(); if (uniqueIps.length === 0) { elements.aliasListContainer.innerHTML = '<p>日志中暂无客户端 IP 记录。</p>'; return; } uniqueIps.forEach(ip => { const item = document.createElement('div'); item.className = 'alias-item'; item.innerHTML = `<span style="font-weight:600;">${ip}</span> <input type="text" placeholder="设置别名..." value="${state.clientAliases[ip] || ''}"> <button class="button primary">保存</button>`; item.querySelector('button').addEventListener('click', () => { const newName = item.querySelector('input').value.trim(); this.set(ip, newName); ui.showToast(`已保存 ${ip} 的别名`, 'success'); }); elements.aliasListContainer.appendChild(item); }); },
            export: () => { const dataStr = JSON.stringify(state.clientAliases, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mosdns-aliases-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); ui.showToast('配置已导出', 'success'); },
            import: (file) => { const reader = new FileReader(); reader.onload = (e) => { try { const newAliases = JSON.parse(e.target.result); if (typeof newAliases !== 'object' || newAliases === null || Array.isArray(newAliases)) throw new Error('无效的JSON对象格式'); state.clientAliases = { ...state.clientAliases, ...newAliases }; this.save(); this.renderEditableList(); rerenderAllViews(); ui.showToast('配置已成功导入并合并', 'success'); } catch (error) { ui.showToast(`导入失败: ${error.message}`, 'error'); } }; reader.readAsText(file); },
        };

        const themeManager = {
            init() { const savedTheme = localStorage.getItem('mosdns-theme') || 'dark'; const savedColor = localStorage.getItem('mosdns-color') || 'indigo'; this.setTheme(savedTheme, false); this.setColor(savedColor, false); elements.lightThemeBtn?.addEventListener('click', () => this.setTheme('light')); elements.darkThemeBtn?.addEventListener('click', () => this.setTheme('dark')); elements.colorSwatches.forEach(swatch => { swatch.addEventListener('click', () => this.setColor(swatch.dataset.color)); }); },
            setTheme(theme, save = true) { 
                elements.html.setAttribute('data-theme', theme);
                if (elements.lightThemeBtn) {
                    elements.lightThemeBtn.classList.toggle('active', theme === 'light');
                    elements.darkThemeBtn.classList.toggle('active', theme === 'dark');
                }
                if (save) localStorage.setItem('mosdns-theme', theme); 
            },
            setColor(color, save = true) { elements.html.setAttribute('data-color-scheme', color); document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active')); document.querySelectorAll(`.color-swatch[data-color="${color}"]`).forEach(s => s.classList.add('active')); if (save) localStorage.setItem('mosdns-color', color); if (color === 'indigo') { if (elements.statCard1) elements.statCard1.className = 'stat-card default-gradient-1'; if (elements.statCard2) elements.statCard2.className = 'stat-card default-gradient-2'; } else { if (elements.statCard1) elements.statCard1.className = 'stat-card theme-gradient'; if (elements.statCard2) elements.statCard2.className = 'stat-card theme-gradient'; } }
        };

        const animateValue = (element, start, end, duration) => { if (!element || start === null || end === null) return; if (start === end) { element.textContent = (element.id === 'avg-duration' ? parseFloat(end).toFixed(2) : Math.floor(end).toLocaleString()); return; } let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); const current = start + progress * (end - start); element.textContent = (element.id === 'avg-duration' ? parseFloat(current).toFixed(2) : Math.floor(current).toLocaleString()); if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); };
        const setupGlowEffect = () => { elements.container?.addEventListener('mousemove', (e) => { const card = e.target.closest('.card'); if (card) { const rect = card.getBoundingClientRect(); card.style.setProperty('--glow-x', `${e.clientX - rect.left}px`); card.style.setProperty('--glow-y', `${e.clientY - rect.top}px`); } }); };
        const generateSparklineSVG = (data, width = 100, height = 30) => { if (!data || data.length < 2) return ''; const max = Math.max(...data); const min = Math.min(...data); const range = max - min === 0 ? 1 : max - min; const points = data.map((d, i) => { const x = (i / (data.length - 1)) * width; const y = height - ((d - min) / range) * height; return `${x.toFixed(2)},${y.toFixed(2)}`; }); const pathD = `M ${points.join(' L ')}`; const fillPathD = `${pathD} L ${width},${height} L 0,${height} Z`; return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><defs><linearGradient id="sparkline-gradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="var(--color-accent-text, #fff)" stop-opacity="0.5" /><stop offset="100%" stop-color="var(--color-accent-text, #fff)" stop-opacity="0" /></linearGradient></defs><path d="${fillPathD}" fill="url(#sparkline-gradient)" /><path d="${pathD}" class="sparkline-path" fill="none" /></svg>`; };
        const renderTable = (tbody, data, renderRow, tableType) => { if (!tbody) return; tbody.innerHTML = ''; if (!data || data.length === 0) { const colspan = tbody.previousElementSibling?.rows[0]?.cells.length || 2; const emptyRow = document.createElement('tr'); emptyRow.className = 'empty-state-row'; const message = tableType === 'log-query' ? '没有匹配的日志记录，请尝试调整搜索词。' : '请确保审计功能已开启并有DNS查询。'; emptyRow.innerHTML = `<td colspan="${colspan}"><div class="empty-state-content"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>暂无数据</strong><p>${message}</p></div></td>`; tbody.appendChild(emptyRow); return; } data.forEach((item, index) => tbody.appendChild(renderRow(item, index))); };
        
        const renderTopDomains = (data) => renderTable(elements.topDomainsBody, data, item => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="col-domain" title="${item.name}"><span class="truncate-text">${item.name}</span></td><td class="text-right"><a href="#log-query" class="clickable-link" data-filter-value="${item.name}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-domains');
        const renderTopClients = (data) => renderTable(elements.topClientsBody, data, item => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="col-client">${aliasManager.getDisplayName(item.ip)}</td><td class="text-right"><a href="#log-query" class="clickable-link" data-filter-value="${item.ip}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-clients');
        const renderSlowestQueries = (data) => renderTable(elements.slowestQueriesBody, data, (item, index) => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="col-time hide-on-mobile">${formatDate(item.query_time)}</td><td class="col-domain details-trigger" data-log-index="${index}" data-log-source="slowest" title="${item.query_name}"><span class="truncate-text">${item.query_name}</span></td><td class="col-duration text-right hide-on-mobile">${item.duration_ms.toFixed(2)}</td><td class="col-client hide-on-mobile">${aliasManager.getDisplayName(item.client_ip)}</td><td class="col-response hide-on-mobile">${getResponseSummary(item)}</td>`; return tr; }, 'slowest-queries');
        
        function processLogs(logs) {
            if (!logs || !Array.isArray(logs)) return { topDomains: [], topClients: [], slowestQueries: [] };
            state.data.totalQueries.previous = state.data.totalQueries.current ?? 0;
            state.data.avgDuration.previous = state.data.avgDuration.current ?? 0.00;
            state.data.totalQueries.current = logs.length;
            state.data.avgDuration.current = logs.length > 0 ? (logs.reduce((sum, log) => sum + log.duration_ms, 0) / logs.length) : 0;
            const domainCounts = logs.reduce((acc, log) => { acc[log.query_name] = (acc[log.query_name] || 0) + 1; return acc; }, {});
            const topDomains = Object.entries(domainCounts).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count).slice(0, 50);
            const clientCounts = logs.reduce((acc, log) => { acc[log.client_ip] = (acc[log.client_ip] || 0) + 1; return acc; }, {});
            const topClients = Object.entries(clientCounts).map(([ip, count]) => ({ ip, count })).sort((a, b) => b.count - a.count).slice(0, 50);
            state.slowestQueries = [...logs].sort((a, b) => b.duration_ms - a.duration_ms).slice(0, 50);
            return { topDomains, topClients, slowestQueries: state.slowestQueries };
        }

        let updateController;
        async function updatePageData() {
            if (state.isUpdating) return;
            state.isUpdating = true;
            if (updateController) updateController.abort();
            updateController = new AbortController();
            const signal = updateController.signal;
            elements.globalRefreshBtn.setAttribute('aria-busy', 'true');
            try {
                const [statusResponse, logsResponse, capacityResponse] = await Promise.allSettled([
                    api.getStatus(signal), api.getLogs(signal), api.getCapacity(signal)
                ]);
                ui.updateStatus(statusResponse.status === 'fulfilled' ? statusResponse.value?.capturing : null);
                state.allLogs = (logsResponse.status === 'fulfilled' && logsResponse.value) ? logsResponse.value : state.allLogs;
                ui.updateCapacity(capacityResponse.status === 'fulfilled' ? capacityResponse.value?.capacity : null);
                rerenderAllViews();
            } catch (error) {
                if (error.name !== 'AbortError') console.error("Page update failed:", error);
            } finally {
                elements.globalRefreshBtn.setAttribute('aria-busy', 'false');
                state.isUpdating = false;
            }
        }
        
        function rerenderAllViews() {
            const activeTabLink = document.querySelector('.tab-link.active');
            if (!activeTabLink) return;

            const activeTabId = activeTabLink.dataset.tab;
            elements.tabContents.forEach(el => {
                el.classList.toggle('active', el.id === `${activeTabId}-tab`);
            });

            const { topDomains, topClients, slowestQueries } = processLogs(state.allLogs);
            ui.updateOverviewStats();

            if (activeTabId === 'overview') {
                renderTopDomains(topDomains);
                renderTopClients(topClients);
                renderSlowestQueries(slowestQueries);
            } else if (activeTabId === 'log-query') {
                applyLogFilterAndRender();
            }
        }
        
        function applyLogFilterAndRender() {
            if (!elements.logSearch) return;
            const searchTerm = elements.logSearch.value.toLowerCase();
            state.filteredLogs = searchTerm ? state.allLogs.filter(log => {
                const alias = (state.clientAliases[log.client_ip] || '').toLowerCase();
                const responseMatch = log.answers?.some(answer => answer.data?.toLowerCase().includes(searchTerm));
                return log.query_name.toLowerCase().includes(searchTerm) || log.client_ip.toLowerCase().includes(searchTerm) || (alias && alias.includes(searchTerm)) || responseMatch;
            }) : state.allLogs;
            state.currentPage = 0;
            loadMoreLogs();
        }
        
        function loadMoreLogs() {
            if (state.isLoadingMore) return;
            const start = state.currentPage * CONSTANTS.LOGS_PER_PAGE;
            if (start >= state.filteredLogs.length && state.currentPage > 0) return;
            state.isLoadingMore = true;
            if (elements.logLoader) elements.logLoader.style.display = 'block';
            
            const logsToRender = state.filteredLogs.slice(start, start + CONSTANTS.LOGS_PER_PAGE);
            setTimeout(() => {
                ui.renderLogTable(logsToRender, state.currentPage > 0);
                state.currentPage++;
                state.isLoadingMore = false;
                if (elements.logLoader) elements.logLoader.style.display = 'none';
            }, 50);
        }

        function formatDate(isoString) { return isoString ? new Date(isoString).toLocaleString('zh-CN', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\//g, '-') : 'N/A'; }
        let activeTooltip = null, hideTooltipTimeout = null;
        function showTooltip(targetElement) { clearTimeout(hideTooltipTimeout); const targetId = targetElement.dataset.logIndex + (targetElement.dataset.logSource || ''); if (activeTooltip && activeTooltip.dataset.targetId === targetId) return; hideTooltip(true); const logIndex = parseInt(targetElement.dataset.logIndex, 10); const logSource = targetElement.dataset.logSource; let log = logSource === 'slowest' ? state.slowestQueries[logIndex] : state.filteredLogs[logIndex]; if (!log) return; activeTooltip = document.createElement('div'); activeTooltip.className = 'answers-tooltip'; activeTooltip.innerHTML = getTooltipHTML(log); activeTooltip.dataset.targetId = targetId; activeTooltip.addEventListener('mouseenter', () => clearTimeout(hideTooltipTimeout)); activeTooltip.addEventListener('mouseleave', () => hideTooltip()); document.body.appendChild(activeTooltip); const targetRect = targetElement.getBoundingClientRect(); const tooltipRect = activeTooltip.getBoundingClientRect(); let top = targetRect.top - tooltipRect.height - 10; let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2); if (top < 10) { top = targetRect.bottom + 10; } if (left < 10) { left = 10; } else if (left + tooltipRect.width > window.innerWidth - 10) { left = window.innerWidth - tooltipRect.width - 10; } activeTooltip.style.top = `${top}px`; activeTooltip.style.left = `${left}px`; setTimeout(() => activeTooltip.classList.add('visible'), 10); }
        function hideTooltip(immediate = false) { clearTimeout(hideTooltipTimeout); if (immediate) { activeTooltip?.remove(); activeTooltip = null; } else { hideTooltipTimeout = setTimeout(() => { if (activeTooltip) { activeTooltip.classList.remove('visible'); setTimeout(() => { activeTooltip?.remove(); activeTooltip = null; }, 200); } }, 100); } }
        function getResponseSummary(log) { if (!log) return 'N/A'; const answers = log.answers || []; if (log.response_code !== 'NOERROR') return log.response_code; if (answers.length > 0) { const firstIp = answers.find(a => a.type === 'A' || a.type === 'AAAA'); const firstCname = answers.find(a => a.type === 'CNAME'); let mainText = firstIp ? firstIp.data : (firstCname ? firstCname.data : answers[0].data); if (answers.length > 1) mainText += ` (+${answers.length - 1})`; return mainText; } return 'NOERROR (empty)'; }
        function getTooltipHTML(log) { if (!log) return ''; const answers = log.answers || []; const flags = log.response_flags || {}; const flagItems = []; if (flags.ra) flagItems.push('ra'); if (flags.aa) flagItems.push('aa'); if (flags.tc) flagItems.push('tc'); let tooltipHTML = `<h5>查询详情</h5><ul><li><strong>客户端:</strong> ${aliasManager.getDisplayName(log.client_ip)}</li><li><strong>类型:</strong> ${log.query_type || 'N/A'}</li><li><strong>耗时:</strong> ${log.duration_ms.toFixed(2)} ms</li><li><strong>状态:</strong> ${log.response_code || 'N/A'}</li>${flagItems.length > 0 ? `<li><strong>标志:</strong> ${flagItems.join(', ')}</li>` : ''}${log.query_class ? `<li><strong>类别:</strong> ${log.query_class}</li>` : ''}${log.trace_id ? `<li><strong>Trace ID:</strong> <small>${log.trace_id}</small></li>` : ''}</ul>`; if (answers.length > 0) { tooltipHTML += `<h5 style="margin-top:0.5rem;">应答记录 (${answers.length})</h5><ul>${answers.map(ans => `<li>[${ans.type}] ${ans.data} (TTL: ${ans.ttl}s)</li>`).join('')}</ul>`; } return tooltipHTML; }
        
        let searchTimeout;
        
        const autoRefreshManager = {
            start() { this.stop(); if (state.autoRefresh.enabled && state.autoRefresh.intervalSeconds >= 5) { state.autoRefresh.intervalId = setInterval(updatePageData, state.autoRefresh.intervalSeconds * 1000); } },
            stop() { if (state.autoRefresh.intervalId) { clearInterval(state.autoRefresh.intervalId); state.autoRefresh.intervalId = null; } },
            updateSettings(enabled, seconds) { state.autoRefresh.enabled = enabled; state.autoRefresh.intervalSeconds = Math.max(seconds, 5); localStorage.setItem('mosdnsAutoRefresh', JSON.stringify({ enabled: state.autoRefresh.enabled, intervalSeconds: state.autoRefresh.intervalSeconds })); this.start(); ui.showToast(`自动刷新已${enabled ? `开启, 频率: ${state.autoRefresh.intervalSeconds}秒` : '关闭'}`, 'success'); },
            loadSettings() { const saved = JSON.parse(localStorage.getItem('mosdnsAutoRefresh')); if (saved) { state.autoRefresh.enabled = saved.enabled ?? true; state.autoRefresh.intervalSeconds = saved.intervalSeconds || CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL; } elements.autoRefreshToggle.checked = state.autoRefresh.enabled; elements.autoRefreshIntervalInput.value = state.autoRefresh.intervalSeconds; elements.autoRefreshIntervalInput.disabled = !state.autoRefresh.enabled; }
        };

        function handleNavigation(targetLink) {
            if (!targetLink || !elements.navContainer) return;
            
            elements.tabLinks.forEach(link => link.classList.remove('active'));
            targetLink.classList.add('active');

            const targetRect = targetLink.getBoundingClientRect();
            const navPadding = parseFloat(getComputedStyle(elements.navContainer).paddingLeft);
            
            elements.navSlider.style.width = `${targetRect.width}px`;
            elements.navSlider.style.transform = `translateX(${targetLink.offsetLeft - navPadding}px)`;

            const newHash = targetLink.getAttribute('href');
            if (window.location.hash !== newHash) {
                history.pushState(null, '', newHash);
            }
            rerenderAllViews();
        }
        
        function setupDetailsInteraction() {
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            if (isTouchDevice) {
                // Mobile/Touch: Click to toggle
                let lastClickedTarget = null;
                document.body.addEventListener('click', e => {
                    const trigger = e.target.closest('td.details-trigger');
                    if (trigger) {
                        if (activeTooltip && lastClickedTarget === trigger) {
                            hideTooltip(true);
                            lastClickedTarget = null;
                        } else {
                            showTooltip(trigger);
                            lastClickedTarget = trigger;
                        }
                    } else if (activeTooltip) {
                        hideTooltip(true);
                        lastClickedTarget = null;
                    }
                });
            } else {
                // Desktop/Mouse: Hover to show/hide
                document.body.addEventListener('mouseover', e => {
                    const trigger = e.target.closest('td.details-trigger');
                    if (trigger) showTooltip(trigger);
                });
                document.body.addEventListener('mouseout', e => {
                    const trigger = e.target.closest('td.details-trigger');
                    if (trigger) hideTooltip();
                });
            }
        }

        function init() {
            elements.tabLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); handleNavigation(link); }); });
            window.addEventListener('popstate', () => { const hash = window.location.hash || '#overview'; const targetLink = document.querySelector(`.tab-link[href="${hash}"]`); handleNavigation(targetLink || elements.tabLinks[0]); });
            window.addEventListener('resize', () => { const activeLink = document.querySelector('.tab-link.active'); if (activeLink) handleNavigation(activeLink); });

            setupDetailsInteraction();
            
            elements.globalRefreshBtn?.addEventListener('click', updatePageData);
            
            elements.autoRefreshForm.addEventListener('change', (e) => {
                if(e.target.type === 'checkbox' || e.target.type === 'number') {
                    const enabled = elements.autoRefreshToggle.checked;
                    const interval = parseInt(elements.autoRefreshIntervalInput.value, 10);
                    elements.autoRefreshIntervalInput.disabled = !enabled;
                    autoRefreshManager.updateSettings(enabled, interval);
                }
            });
            document.addEventListener('visibilitychange', () => { document.hidden ? autoRefreshManager.stop() : autoRefreshManager.start(); });

            elements.container.addEventListener('click', (e) => { const link = e.target.closest('.clickable-link'); if (link) { e.preventDefault(); if (elements.logSearch) { elements.logSearch.value = link.dataset.filterValue; } const logQueryLink = document.querySelector('.tab-link[href="#log-query"]'); if (logQueryLink) handleNavigation(logQueryLink); } });
            elements.toggleAuditBtn?.addEventListener('click', async (e) => { const btn = e.currentTarget; ui.setLoading(btn, true); try { if (state.isCapturing) { await api.stop(); } else { await api.start(); } } catch (error) { console.error("操作失败:", error); } await updatePageData(); });
            elements.clearAuditBtn?.addEventListener('click', async (e) => { if (confirm('确定要清空所有内存审计日志吗？此操作不可恢复。')) { const btn = e.currentTarget; ui.setLoading(btn, true); try { await api.clear(); ui.showToast('日志已清空', 'success'); if (elements.logSearch) elements.logSearch.value = ''; } catch (error) { ui.showToast('清空日志失败', 'error'); } finally { await updatePageData(); ui.setLoading(btn, false); } } });
            elements.capacityForm?.addEventListener('submit', async (e) => { e.preventDefault(); const newCapacity = parseInt(elements.newCapacityInput.value, 10); if (!newCapacity || newCapacity <= 0 || newCapacity > 100000) { ui.showToast('请输入1到100000之间的有效容量', 'error'); return; } if (confirm(`确定要将容量设置为 ${newCapacity} 吗？\n注意：这将清空当前所有日志。`)) { const btn = e.currentTarget.querySelector('button'); ui.setLoading(btn, true); try { await api.setCapacity(newCapacity); ui.showToast(`容量已成功设置为 ${newCapacity}`, 'success'); elements.newCapacityInput.value = ''; } catch (error) { console.error("Set capacity failed:", error); } finally { await updatePageData(); ui.setLoading(btn, false); } } });
            elements.logSearch?.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyLogFilterAndRender, 300); });
            elements.logQueryTableContainer?.addEventListener('scroll', () => { const { scrollTop, scrollHeight, clientHeight } = elements.logQueryTableContainer; if (clientHeight + scrollTop >= scrollHeight - 200 && !state.isLoadingMore) { loadMoreLogs(); } });
            if (elements.aliasModal) { document.getElementById('manage-aliases-btn')?.addEventListener('click', () => { aliasManager.renderEditableList(); elements.aliasModal.showModal(); }); document.getElementById('close-alias-modal')?.addEventListener('click', () => elements.aliasModal.close()); document.getElementById('export-aliases-btn')?.addEventListener('click', () => aliasManager.export()); document.getElementById('import-aliases-btn')?.addEventListener('click', () => elements.importAliasInput?.click()); elements.importAliasInput?.addEventListener('change', (e) => { if (e.target.files?.length > 0) { aliasManager.import(e.target.files[0]); e.target.value = ''; } }); }

            themeManager.init();
            aliasManager.load();
            autoRefreshManager.loadSettings();
            
            const initialHash = window.location.hash || '#overview';
            const initialLink = document.querySelector(`.tab-link[href="${initialHash}"]`);
            setTimeout(() => {
                handleNavigation(initialLink || elements.tabLinks[0]);
                updatePageData();
                if (!document.hidden) autoRefreshManager.start();
            }, 50);

            setupGlowEffect();
        }

        init();
    });
    </script>
</body>
</html>
